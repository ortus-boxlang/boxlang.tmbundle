name: Tests

on:
  workflow_call:
    inputs:
      checkout-ref:
        description: 'Git ref to checkout'
        required: false
        type: string
        default: ''

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.checkout-ref }}

    - name: Check required files exist
      run: |
        echo "Checking bundle structure..."

        # Check main bundle file
        test -f info.plist || (echo "‚ùå Missing info.plist" && exit 1)
        echo "‚úÖ info.plist exists"

        # Check main directories
        test -d Syntaxes/ || (echo "‚ùå Missing Syntaxes directory" && exit 1)
        echo "‚úÖ Syntaxes directory exists"

        test -d Commands/ || echo "‚ö†Ô∏è  Commands directory missing"
        test -d Snippets/ || echo "‚ö†Ô∏è  Snippets directory missing"
        test -d Preferences/ || echo "‚ö†Ô∏è  Preferences directory missing"

        echo "Bundle structure validation complete"

    - name: Validate plist files
      run: |
        echo "Validating plist files..."

        # Basic XML validation for plist files
        for file in $(find . -name "*.plist" -o -name "*.tmCommand" -o -name "*.tmPreferences" -o -name "*.tmSnippet"); do
          echo "Checking $file"

          # Check if file is empty
          if [ ! -s "$file" ]; then
            echo "‚ùå Empty file: $file"
            exit 1
          fi

          # Basic XML structure check
          if ! grep -q "<?xml" "$file"; then
            echo "‚ùå Missing XML declaration in: $file"
            exit 1
          fi

          if ! grep -q "<plist" "$file"; then
            echo "‚ùå Missing plist tag in: $file"
            exit 1
          fi

          echo "‚úÖ $file appears valid"
        done

        echo "Plist validation complete"

    - name: Check syntax files
      run: |
        echo "Checking syntax files..."

        if [ -d "Syntaxes/" ]; then
          syntax_files=$(find Syntaxes/ -name "*.tmLanguage" -o -name "*.json" -o -name "*.yaml" -o -name "*.yml" | wc -l)

          if [ "$syntax_files" -eq 0 ]; then
            echo "‚ùå No syntax files found in Syntaxes directory"
            exit 1
          fi

          echo "‚úÖ Found $syntax_files syntax file(s)"

          # List syntax files for visibility
          find Syntaxes/ -name "*.tmLanguage" -o -name "*.json" -o -name "*.yaml" -o -name "*.yml" | while read file; do
            echo "  - $file"

            # Basic file validation
            if [ ! -s "$file" ]; then
              echo "‚ùå Empty syntax file: $file"
              exit 1
            fi
          done
        fi

    - name: Summary
      run: |
        echo ""
        echo "üìã Validation Summary:"
        echo "‚úÖ Bundle structure validated"
        echo "‚úÖ Plist files checked"
        echo "‚úÖ Syntax files verified"
        echo ""
        echo "üéØ Your BoxLang TextMate bundle looks good!"
